# yaml-language-server: $schema=https://raw.githubusercontent.com/prefix-dev/recipe-format/main/schema.json

schema_version: 1

context:
  api_version: "4"
  cmake_version: ${{ env.get('PIXI_BUILD_CMAKE_VERSION', default='0.1.0dev') }}
  mojo_version: ${{ env.get('PIXI_BUILD_MOJO_VERSION', default='0.1.0dev') }}
  python_backend_version: ${{ env.get('PIXI_BUILD_PYTHON_VERSION', default='0.1.0dev') }}
  rattler_build_version: ${{ env.get('PIXI_BUILD_RATTLER_BUILD_VERSION', default='0.1.0dev') }}
  rust_version: ${{ env.get('PIXI_BUILD_RUST_VERSION', default='0.1.0dev') }}
  py_pixi_build_backend_version: ${{ env.get('PY_PIXI_BUILD_BACKEND_VERSION', default='0.1.0dev') }}
  ros_version: ${{ env.get('PIXI_BUILD_ROS_VERSION', default='0.1.0dev') }}

recipe:
  name: pixi-build-backends
  version: 0.0.0

outputs:
  # === Staging output for Rust backends (builds once, cached for all Rust backend packages) ===
  - staging:
      name: rust-backends-build
    source:
      - path: ../../..
        filter:
          exclude:
            - .git
    requirements:
      build:
        - ${{ compiler("rust") }}
        - ${{ stdlib("c") }}
        - cargo-bundle-licenses
        - cargo-auditable
      host:
        - pkg-config
        - libzlib
        - liblzma
        - if: unix
          then: openssl
    build:
      script:
        env:
          CARGO_PROFILE_RELEASE_STRIP: symbols
        content:
          - if: osx and x86_64
            then:
              # use the default linker for osx-64 as we are hitting a bug with the conda-forge linker
              # https://github.com/rust-lang/rust/issues/140686
              - unset CARGO_TARGET_X86_64_APPLE_DARWIN_LINKER
          - if: unix
            then:
              - export RUSTC_WRAPPER=sccache
              - export OPENSSL_DIR="$PREFIX"
              - export CARGO_TARGET_DIR=${{ SRC_DIR }}/../../../target-cache-rust-backends
          - if: win
            then:
              - set RUSTC_WRAPPER=sccache
              - set "CARGO_TARGET_DIR=${{ SRC_DIR }}\..\..\..\\target-cache-rust-backends"
          # Build all Rust backends at once
          - cargo auditable build --locked --release --bins -p pixi_build_cmake -p pixi_build_mojo -p pixi_build_python -p pixi_build_rattler_build -p pixi_build_rust
          # Install binaries to prefix
          - if: unix
            then:
              - TARGET=${CARGO_BUILD_TARGET:-$(rustc -vV | grep "host:" | awk '{print $2}')}
              - install -Dm755 $CARGO_TARGET_DIR/$TARGET/release/pixi-build-cmake $PREFIX/bin/pixi-build-cmake
              - install -Dm755 $CARGO_TARGET_DIR/$TARGET/release/pixi-build-mojo $PREFIX/bin/pixi-build-mojo
              - install -Dm755 $CARGO_TARGET_DIR/$TARGET/release/pixi-build-python $PREFIX/bin/pixi-build-python
              - install -Dm755 $CARGO_TARGET_DIR/$TARGET/release/pixi-build-rattler-build $PREFIX/bin/pixi-build-rattler-build
              - install -Dm755 $CARGO_TARGET_DIR/$TARGET/release/pixi-build-rust $PREFIX/bin/pixi-build-rust
          - if: win
            then:
              - if not exist "%PREFIX%\bin" mkdir "%PREFIX%\bin"
              - copy %CARGO_TARGET_DIR%\release\pixi-build-cmake.exe %PREFIX%\bin\
              - copy %CARGO_TARGET_DIR%\release\pixi-build-mojo.exe %PREFIX%\bin\
              - copy %CARGO_TARGET_DIR%\release\pixi-build-python.exe %PREFIX%\bin\
              - copy %CARGO_TARGET_DIR%\release\pixi-build-rattler-build.exe %PREFIX%\bin\
              - copy %CARGO_TARGET_DIR%\release\pixi-build-rust.exe %PREFIX%\bin\
          - if: unix
            then: cargo-bundle-licenses --format yaml --output $PREFIX/THIRDPARTY.yml
          - if: win
            then: cargo-bundle-licenses --format yaml --output %PREFIX%\THIRDPARTY.yml

  # === API Version (metadata only) ===
  - package:
      name: pixi-build-api-version
      version: ${{ api_version }}

    build:
      noarch: generic

    source:
      - path: ../../..

    about:
      homepage: https://github.com/prefix-dev/pixi-build-backends
      summary: The protocol version for pixi build backends.
      description: |
        This package is used to define the API version of the protocol used by pixi build backends.
      license: BSD-3-Clause
      license_file:
        - LICENSE
      documentation: https://prefix-dev.github.io/pixi-build-backends
      repository: https://github.com/prefix-dev/pixi-build-backends

  # === pixi-build-cmake ===
  - package:
      name: pixi-build-cmake
      version: ${{ cmake_version }}
    inherit: rust-backends-build
    build:
      files:
        - bin/pixi-build-cmake
        - bin/pixi-build-cmake.exe
        - LICENSE
        - THIRDPARTY.yml
      script:
        - if: unix
          then:
            - mv ${{ PREFIX }}/THIRDPARTY.yml ${{ SRC_DIR }}/THIRDPARTY.yml
          else:
            - move ${{ PREFIX }}\THIRDPARTY.yml ${{ SRC_DIR }}\THIRDPARTY.yml
    requirements:
      run:
        - pixi-build-api-version >=4,<5
    tests:
      - script: pixi-build-cmake --help
      - package_contents:
          bin:
            - pixi-build-cmake
    about:
      homepage: https://github.com/prefix-dev/pixi-build-backends
      summary: A pixi build backend to build CMake based packages.
      description: |
        This package provides a build backend for pixi that allows building packages using CMake.
      license: BSD-3-Clause
      license_file:
        - LICENSE
        - THIRDPARTY.yml
      documentation: https://prefix-dev.github.io/pixi-build-backends
      repository: https://github.com/prefix-dev/pixi-build-backends

  # === pixi-build-mojo ===
  - package:
      name: pixi-build-mojo
      version: ${{ mojo_version }}
    inherit: rust-backends-build
    build:
      files:
        - bin/pixi-build-mojo
        - bin/pixi-build-mojo.exe
        - LICENSE
        - THIRDPARTY.yml
      script:
        - if: unix
          then:
            - mv ${{ PREFIX }}/THIRDPARTY.yml ${{ SRC_DIR }}/THIRDPARTY.yml
          else:
            - move ${{ PREFIX }}\THIRDPARTY.yml ${{ SRC_DIR }}\THIRDPARTY.yml
    requirements:
      run:
        - pixi-build-api-version >=4,<5
    tests:
      - script: pixi-build-mojo --help
      - package_contents:
          bin:
            - pixi-build-mojo
    about:
      homepage: https://github.com/prefix-dev/pixi-build-backends
      summary: A pixi build backend to build Mojo packages.
      description: |
        This package provides a build backend for pixi that allows building packages using the Mojo compiler.
      license: BSD-3-Clause
      license_file:
        - LICENSE
        - THIRDPARTY.yml
      documentation: https://prefix-dev.github.io/pixi-build-backends
      repository: https://github.com/prefix-dev/pixi-build-backends

  # === pixi-build-python ===
  - package:
      name: pixi-build-python
      version: ${{ python_backend_version }}
    inherit: rust-backends-build
    build:
      files:
        - bin/pixi-build-python
        - bin/pixi-build-python.exe
        - LICENSE
        - THIRDPARTY.yml
      script:
        - if: unix
          then:
            - mv ${{ PREFIX }}/THIRDPARTY.yml ${{ SRC_DIR }}/THIRDPARTY.yml
          else:
            - move ${{ PREFIX }}\THIRDPARTY.yml ${{ SRC_DIR }}\THIRDPARTY.yml
    requirements:
      run:
        - pixi-build-api-version >=4,<5
    tests:
      - script: pixi-build-python --help
      - package_contents:
          bin:
            - pixi-build-python
    about:
      homepage: https://github.com/prefix-dev/pixi-build-backends
      summary: A pixi build backend to build Python packages.
      description: |
        This package provides a build backend for pixi that allows building Python packages
        using PEP 517 compatible build systems.
      license: BSD-3-Clause
      license_file:
        - LICENSE
        - THIRDPARTY.yml
      documentation: https://prefix-dev.github.io/pixi-build-backends
      repository: https://github.com/prefix-dev/pixi-build-backends

  # === pixi-build-rattler-build ===
  - package:
      name: pixi-build-rattler-build
      version: ${{ rattler_build_version }}
    inherit: rust-backends-build
    build:
      files:
        - bin/pixi-build-rattler-build
        - bin/pixi-build-rattler-build.exe
        - LICENSE
        - THIRDPARTY.yml
      script:
        - if: unix
          then:
            - mv ${{ PREFIX }}/THIRDPARTY.yml ${{ SRC_DIR }}/THIRDPARTY.yml
          else:
            - move ${{ PREFIX }}\THIRDPARTY.yml ${{ SRC_DIR }}\THIRDPARTY.yml
    requirements:
      run:
        - pixi-build-api-version >=4,<5
    tests:
      - script: pixi-build-rattler-build --help
      - package_contents:
          bin:
            - pixi-build-rattler-build
    about:
      homepage: https://github.com/prefix-dev/pixi-build-backends
      summary: A pixi build backend to build recipe.yaml files.
      description: |
        This package provides a build backend for pixi that allows building packages
        using rattler-build recipe.yaml files.
      license: BSD-3-Clause
      license_file:
        - LICENSE
        - THIRDPARTY.yml
      documentation: https://prefix-dev.github.io/pixi-build-backends
      repository: https://github.com/prefix-dev/pixi-build-backends

  # === pixi-build-rust ===
  - package:
      name: pixi-build-rust
      version: ${{ rust_version }}
    inherit: rust-backends-build
    build:
      files:
        - bin/pixi-build-rust
        - bin/pixi-build-rust.exe
        - LICENSE
        - THIRDPARTY.yml
      script:
        - if: unix
          then:
            - mv ${{ PREFIX }}/THIRDPARTY.yml ${{ SRC_DIR }}/THIRDPARTY.yml
          else:
            - move ${{ PREFIX }}\THIRDPARTY.yml ${{ SRC_DIR }}\THIRDPARTY.yml
    requirements:
      run:
        - pixi-build-api-version >=4,<5
    tests:
      - script: pixi-build-rust --help
      - package_contents:
          bin:
            - pixi-build-rust
    about:
      homepage: https://github.com/prefix-dev/pixi-build-backends
      summary: A pixi build backend to build Rust packages.
      description: |
        This package provides a build backend for pixi that allows building Rust packages
        using Cargo.
      license: BSD-3-Clause
      license_file:
        - LICENSE
        - THIRDPARTY.yml
      documentation: https://prefix-dev.github.io/pixi-build-backends
      repository: https://github.com/prefix-dev/pixi-build-backends

  # === py-pixi-build-backend (Python/Rust hybrid) ===
  - package:
      name: py-pixi-build-backend
      version: ${{ py_pixi_build_backend_version }}

    source:
      - path: ../../..

    requirements:
      build:
        - if: build_platform != target_platform
          then:
            - python ${{ python_min }}.*
            - cross-python_${{ target_platform }} ${{ python_min }}.*
            - maturin >=1.2.2,<2
        - ${{ compiler('rust') }}
        - ${{ stdlib('c') }}
      host:
        - python ${{ python_min }}.*
        - python-abi3
        - maturin >=1.2.2,<2
        - pip
      run:
        - python >=${{ python_min }}
        - pixi-build-api-version >=4,<5
      ignore_run_exports:
        from_package:
          - cross-python_${{ target_platform }}

    build:
      script:
        content:
          - if: unix
            then:
              - export RUSTC_WRAPPER=sccache
              - export CARGO_TARGET_DIR=$SRC_DIR/../../../target-cache-py-pixi-build-backends
          - if: win
            then:
              - set RUSTC_WRAPPER=sccache
              - set "CARGO_TARGET_DIR=%SRC_DIR%\..\..\..\target-cache-py-pixi-build-backends"
          - cd pixi-build-backends/py-pixi-build-backend
          - pip install . -vv --no-build-isolation
      python:
        version_independent: true
      files:
        exclude:
          - bin/*

    tests:
      - python:
          python_version: ${{ python_min }}.*
          pip_check: false
          imports:
            - pixi_build_backend

    about:
      homepage: https://github.com/prefix-dev/pixi-build-backends
      summary: Python bindings for pixi-build-backends
      description: |
        This package provides Python bindings for pixi-build-backends, enabling
        Python applications to use the pixi build system programmatically.
      license: BSD-3-Clause
      license_file: LICENSE
      documentation: https://prefix-dev.github.io/pixi-build-backends
      repository: https://github.com/prefix-dev/pixi-build-backends

  # === pixi-build-ros (pure Python) ===
  - package:
      name: pixi-build-ros
      version: ${{ ros_version }}

    source:
      - path: ../../..

    requirements:
      host:
        - python ${{ python_min }}.*
        - hatchling
        - pip
      run:
        - python >=${{ python_min }}
        - rosdistro
        - catkin_pkg
        - pydantic
        - pyyaml
        - py-rattler
        - typing-extensions
        - py-pixi-build-backend >=0.4.1,<0.5

    build:
      skip:
        - target_platform != "linux-64"
      script:
        - ${{ PYTHON }} -m pip install pixi-build-backends/backends/pixi-build-ros -vv --no-build-isolation
      noarch: python
      python:
        entry_points:
          - pixi-build-ros = pixi_build_ros.main:main
      files:
        exclude:
          - bin/*

    tests:
      - script: pixi-build-ros --help

    about:
      homepage: https://github.com/prefix-dev/pixi-build-backends
      summary: ROS build backend for Pixi
      description: |
        This package provides a ROS build backend for Pixi, allowing the integration of ROS packages into the Pixi build system.
      license: BSD-3-Clause
      license_file: LICENSE
      documentation: https://prefix-dev.github.io/pixi-build-backends
      repository: https://github.com/prefix-dev/pixi-build-backends
