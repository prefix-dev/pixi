name: "Backends - Conda Packages"

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "pixi-build-backends/**"
      - "crates/pixi-build-python/**"
      - "crates/pixi-build-rattler-build/**"
      - "crates/pixi-build-cmake/**"
      - "crates/pixi-build-rust/**"
      - "crates/pixi-build-mojo/**"
      - ".github/workflows/backends-release.yml"
  pull_request:
# types: [labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build:
    # if: github.event_name != 'pull_request' || github.event.label.name == 'release:backends'
    timeout-minutes: 40
    permissions:
      id-token: write
      attestations: write
      contents: read
    env:
      REPO_NAME: "prefix-dev/pixi"
      SCCACHE_GHA_ENABLED: "true"
      ACTIONS_CACHE_SERVICE_V2: on
    strategy:
      matrix:
        include:
          - target: linux-64
            os: ubuntu-latest
          - target: linux-aarch64
            os: ubuntu-latest
          - target: win-64
            os: windows-latest
          - target: osx-64
            os: macos-15-intel
          - target: osx-arm64
            os: macos-15
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false
      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7 # v0.9.3
        with:
          environments: backends-release
      - name: Configure sccache
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            core.exportVariable('ACTIONS_RESULTS_URL', process.env.ACTIONS_RESULTS_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
      - name: Enable long paths (Windows)
        if: matrix.os == 'windows-latest'
        run: git config --global core.longpaths true
        shell: bash
      - name: Set package version environment variables
        shell: bash
        run: pixi run -e backends-release generate-versions >> $GITHUB_ENV

      - name: Build all backends for ${{ matrix.target }}
        shell: bash
        env:
          RATTLER_BUILD_ENABLE_GITHUB_INTEGRATION: "true"
          RATTLER_BUILD_COLOR: "always"
        run: |
          pixi run -e backends-release build-backend-packages ${{ matrix.target }}

      - name: Show sccache stats
        shell: bash
        run: pixi run -e backends-release sccache --stop-server

      - uses: actions/attest@daf44fb950173508f38bd2406030372c1d1162b1 # v3.0.0
        id: attest
        with:
          subject-path: "${{ runner.temp }}/**/*.conda"
          predicate-type: "https://schemas.conda.org/attestations-publish-1.schema.json"
          predicate: "{\"targetChannel\": \"https://prefix.dev/pixi-build-backends\"}"

      - name: Generate attestations for conda packages
        shell: bash
        run: pixi run -e backends-release generate-attestations "${{ runner.temp }}" "${{ steps.attest.outputs.bundle-path }}"

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: conda-packages-${{ matrix.target }}
          path: |
            ${{ runner.temp }}/**/*.conda
            ${{ runner.temp }}/**/*.sig

      - name: Kill any lingering processes (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Kill any Python processes
          Get-Process python* -ErrorAction SilentlyContinue | Stop-Process -Force

          # Kill any processes from the pixi environment
          $pixiPath = "${{ github.workspace }}\.pixi\envs\backends-release\bin"
          Get-Process | Where-Object { $_.Path -like "$pixiPath*" } | Stop-Process -Force

          # Wait a moment for handles to be released
          Start-Sleep -Seconds 2

  upload:
    needs: build
    runs-on: ubuntu-latest
    if: github.repository == 'prefix-dev/pixi'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false
      - name: Download all conda packages
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4
        with:
          pattern: conda-packages-*
          path: conda-packages
          merge-multiple: true
          run-id: ${{ github.run_id }}
      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7 # v0.9.3
        with:
          environments: backends-release
      - name: Upload packages
        shell: bash
        run: |
          for file in conda-packages/**/*.conda; do
            echo "Uploading ${file}"
            # Find corresponding attestation file
            ATTESTATION_FILE="${file%.conda}.sig"
            if [ -f "$ATTESTATION_FILE" ]; then
              echo "Found attestation: $ATTESTATION_FILE"
              pixi run -e backends-release rattler-build upload prefix -c pixi-build-backends "$file" --attestation "$ATTESTATION_FILE"
            else
              echo "Warning: No attestation found for $file"
              pixi run -e backends-release rattler-build upload prefix -c pixi-build-backends "$file"
            fi
          done
